name: NotionGitBackup Worker Tick

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

concurrency:
  group: pagevault-worker
  cancel-in-progress: false

jobs:
  tick-worker:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      APP_URL: ${{ secrets.APP_URL }}
      PAGEVAULT_APP_URL: ${{ secrets.PAGEVAULT_APP_URL }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      PAGEVAULT_CRON_SECRET: ${{ secrets.PAGEVAULT_CRON_SECRET }}
    steps:
      - name: Trigger NotionGitBackup worker
        run: |
          app_url="${APP_URL:-$PAGEVAULT_APP_URL}"
          cron_secret="${CRON_SECRET:-$PAGEVAULT_CRON_SECRET}"

          if [ -z "$app_url" ]; then
            echo "::error::Missing secret APP_URL (or PAGEVAULT_APP_URL)"
            exit 1
          fi
          if [ -z "$cron_secret" ]; then
            echo "::error::Missing secret CRON_SECRET (or PAGEVAULT_CRON_SECRET)"
            exit 1
          fi

          response_file="$(mktemp)"
          status_code="$(
            curl --show-error --silent \
              --output "$response_file" \
              --write-out "%{http_code}" \
              -X POST "$app_url/api/worker/run?limit=1&enqueue=1" \
              -H "x-cron-secret: $cron_secret" \
              -H "content-type: application/json" \
              -H "accept: application/json"
          )"

          echo "HTTP $status_code"
          cat "$response_file"
          echo

          if [ "$status_code" -ge 400 ]; then
            exit 1
          fi
