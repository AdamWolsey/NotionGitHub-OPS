name: NotionGitBackup Worker Tick

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

concurrency:
  group: pagevault-worker
  cancel-in-progress: false

jobs:
  tick-worker:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Trigger NotionGitBackup worker
        run: |
          response_file="$(mktemp)"
          status_code="$(
            curl --show-error --silent \
              --output "$response_file" \
              --write-out "%{http_code}" \
              -X POST "${{ secrets.PAGEVAULT_APP_URL }}/api/worker/run?limit=1&enqueue=1" \
              -H "x-cron-secret: ${{ secrets.PAGEVAULT_CRON_SECRET }}" \
              -H "content-type: application/json" \
              -H "accept: application/json"
          )"

          echo "HTTP $status_code"
          cat "$response_file"
          echo

          if [ "$status_code" -ge 400 ]; then
            exit 1
          fi
